# PR Review Workflow

You are performing a comprehensive PR review. This workflow should be run after any PR is opened (excluding spec/plan PRs).

## Instructions

Execute the following steps in order:

### Step 1: Identify PR and Check Eligibility

1. Determine which PR to review:
   - If a PR number was provided as an argument, use that
   - Otherwise, check for open PRs on the current branch using `gh pr list --head $(git branch --show-current)`

2. Check eligibility - skip review if:
   - PR title contains "spec", "plan", or "specification" (case-insensitive)
   - PR is a draft
   - PR is already merged or closed

3. If not eligible, inform the user why and exit.

### Step 2: Gather Context

Run these commands in parallel to gather PR context:
- `gh pr view <PR_NUMBER> --json title,body,files,additions,deletions,changedFiles`
- `git diff main...HEAD --stat` (to see what changed)
- Read any CLAUDE.md files in the repository for project conventions
- Check for new migration files: `git diff main...HEAD --name-only | grep migrations`

### Step 3: Launch Review Agents

Launch 5 parallel review agents using the Task tool with **model: "sonnet"** (minimum). Each agent focuses on a specific review aspect:

1. **CLAUDE.md Compliance Agent**
   - Check if changes follow project conventions documented in CLAUDE.md
   - Look for naming conventions, architecture patterns, file organization
   - Verify design system patterns are followed (if applicable)

2. **Bug & Logic Scan Agent**
   - Look for potential bugs, logic errors, edge cases
   - Check for security vulnerabilities (OWASP top 10)
   - Verify error handling is appropriate

3. **Git History Context Agent**
   - Review recent commits on this branch
   - Understand the evolution of changes
   - Check for any reverted or contradictory changes

4. **Similar PRs Analysis Agent**
   - Look at recently merged PRs for patterns
   - Check if this PR follows established conventions
   - Identify any inconsistencies with past work

5. **Code Comments & Documentation Agent**
   - Check if complex logic is documented
   - Verify public APIs have appropriate documentation
   - Look for outdated or misleading comments

### Step 4: Score and Filter Issues

For each issue found by the agents:

1. Score the issue 0-100 based on:
   - **Confidence**: How certain is this actually an issue? (weight: 40%)
   - **Severity**: How serious is the problem? (weight: 35%)
   - **Actionability**: How clear is the fix? (weight: 25%)

2. Filter issues:
   - **Critical (90-100)**: Must fix before merge
   - **Major (80-89)**: Should fix before merge
   - **Minor (60-79)**: Nice to have, mention in review
   - **Below 60**: Likely false positive, do not include

3. Only include issues scoring 80+ in the review comment.

### Step 5: Post Review Comment

Post a review comment to the PR using `gh pr review <PR_NUMBER> --comment --body "..."` with this format:

```markdown
# Code Review: PR #<NUMBER> - <TITLE>

**Reviewer:** Claude Code Review
**Date:** <DATE>
**Branch:** `<BRANCH_NAME>`

---

## Files Reviewed

<List of files with brief descriptions>

---

## Critical Issues (90-100) - Must Fix

<List issues or "None identified.">

---

## Major Issues (80-89) - Should Fix

<List issues or "None identified.">

---

## Strengths - What's Done Well

<2-4 positive observations about the code>

---

## Summary

<Brief overall assessment and recommendation>

---

*Review generated by Claude Code*
```

If no issues scored 80+, use this simplified format:

```markdown
# Code Review: PR #<NUMBER> - <TITLE>

**Reviewer:** Claude Code Review
**Date:** <DATE>

---

**Result:** No critical or major issues found.

All identified concerns scored below the 80-point threshold for inclusion.

---

## Strengths

<2-4 positive observations>

---

*Review generated by Claude Code*
```

### Step 6: Fix Critical/Major Issues (If Found)

**IMPORTANT:** If any issues scored 80+ were identified:

1. **Fix the issues immediately** before continuing
2. For each critical/major issue:
   - Read the affected file(s)
   - Make the necessary corrections
   - Verify the fix doesn't break anything
3. After all fixes are complete:
   - Stage the changes: `git add -A`
   - Commit with message: `fix: Address PR review feedback`
   - Push to the branch: `git push`

### Step 7: Wait for CI

1. Check CI status: `gh pr checks <PR_NUMBER>`
2. If CI is still running, wait and check again
3. If CI fails, investigate and fix the issues
4. Repeat until CI passes

### Step 8: Re-review (If Fixes Were Made)

If fixes were made in Step 6:
1. Run a lighter review focusing only on the fixed areas
2. Verify the fixes properly address the original issues
3. Post a follow-up comment confirming fixes

### Step 9: Check for Pending Migrations

If migration files were detected in Step 2:

```markdown
## ⚠️ Database Migration Required

This PR includes database schema changes:

| File | Description |
|------|-------------|
| `backend/migrations/NNNNNN_*.up.sql` | [Migration name] |

**Before testing this feature locally, run `/migrate` to apply the schema changes.**
```

### Step 10: Report Completion

Inform the user:
- PR review posted successfully
- Any issues found and fixed
- CI status
- Whether the PR is ready for merge
- **If migrations exist**: Remind to run `/migrate` before testing

---

## Notes

- This workflow uses Sonnet agents for thorough code review
- Issues are scored to filter false positives
- Critical/major issues are fixed immediately, not just reported
- The review is posted as a GitHub comment for tracking purposes
