# PR Review Workflow

You are performing a comprehensive PR review. This workflow should be run after any PR is opened.

## Instructions

Execute the following steps in order:

### Step 1: Identify PR and Check Eligibility

1. Determine which PR to review:
   - If a PR number was provided as an argument, use that
   - Otherwise, check for open PRs on the current branch using `gh pr list --head $(git branch --show-current)`

2. Check eligibility - skip review if:
   - PR is a draft
   - PR is already merged or closed

3. If not eligible, inform the user why and exit.

### Step 2: Gather Context

Run these commands in parallel to gather PR context:
- `gh pr view <PR_NUMBER> --json title,body,files,additions,deletions,changedFiles`
- `git diff main...HEAD --stat` (to see what changed)
- Read any CLAUDE.md files in the repository for project conventions
- Check for new migration files: `git diff main...HEAD --name-only | grep migrations`

### Step 3: Launch Review Agents

Launch **3 focused review agents** using the Task tool with **model: "sonnet"** (minimum):

1. **Code Quality & Conventions Agent**
   - Check if changes follow project conventions documented in CLAUDE.md
   - Look for naming conventions, architecture patterns, file organization
   - Verify design system patterns are followed (if applicable)
   - Check if complex logic is documented appropriately

2. **Bug & Security Scan Agent**
   - Look for potential bugs, logic errors, edge cases
   - Check for security vulnerabilities (OWASP top 10)
   - Verify error handling is appropriate
   - Look for race conditions, null pointer issues, etc.

3. **Git Context & Consistency Agent**
   - Review recent commits on this branch
   - Look at recently merged PRs for patterns
   - Check if this PR follows established conventions
   - Identify any inconsistencies with past work

### Step 4: Score and Filter Issues

For each issue found by the agents:

1. Score the issue 0-100 based on:
   - **Confidence**: How certain is this actually an issue? (weight: 40%)
   - **Severity**: How serious is the problem? (weight: 35%)
   - **Actionability**: How clear is the fix? (weight: 25%)

2. Filter issues:
   - **Critical (90-100)**: Must fix before merge
   - **Major (80-89)**: Should fix before merge
   - **Minor (60-79)**: Nice to have, mention in review
   - **Below 60**: Likely false positive, do not include

3. Only include issues scoring 80+ in the review comment.

### Step 5: Post Review Comment

Post a review comment to the PR using `gh pr review <PR_NUMBER> --comment --body "..."` with this format:

```markdown
## Code Review: PR #<NUMBER> - <TITLE>

**Reviewer:** Claude Code Review
**Date:** <DATE>
**Branch:** `<BRANCH_NAME>`

---

### Files Reviewed

<List of files with brief descriptions>

---

### Critical Issues (90-100) - Must Fix

<List issues or "None identified.">

---

### Major Issues (80-89) - Should Fix

<List issues or "None identified.">

---

### Strengths - What's Done Well

<2-4 positive observations about the code>

---

### Summary

<Brief overall assessment>

---

*Review generated by Claude Code*
```

If no issues scored 80+, use this simplified format:

```markdown
## Code Review: PR #<NUMBER> - <TITLE>

**Reviewer:** Claude Code Review
**Date:** <DATE>

---

**Result:** No critical or major issues found.

All identified concerns scored below the 80-point threshold for inclusion.

---

### Strengths

<2-4 positive observations>

---

*Review generated by Claude Code*
```

### Step 6: Fix Critical/Major Issues (If Found)

**IMPORTANT:** If any issues scored 80+ were identified:

1. **Fix the issues** before continuing
2. For each critical/major issue:
   - Read the affected file(s)
   - Make the necessary corrections
   - Verify the fix doesn't break anything
3. After all fixes are complete:
   - Stage the changes: `git add -A`
   - Commit with message: `fix: Address PR review feedback`
   - Push to the branch: `git push`

**Track review cycle count:** This is cycle 1 of max 3.

### Step 7: Re-review Cycles (If Fixes Were Made)

**Maximum 2 additional review cycles allowed** (3 total including initial).

If fixes were made in the previous step:

1. Increment cycle count
2. If cycle count > 3:
   - **STOP** - Report that max review cycles reached
   - List any remaining unresolved issues
   - Exit the review workflow
3. Otherwise:
   - Run a lighter review focusing only on the fixed areas
   - Verify the fixes properly address the original issues
   - If new issues found (score 80+), fix them and repeat
   - Post a follow-up comment confirming fixes

### Step 8: Final CI Check

After all review->fix cycles are complete:

1. Check CI status: `gh pr checks <PR_NUMBER>`
2. If CI is still running, wait and check again (poll every 30 seconds, max 5 minutes)
3. If CI fails:
   - Investigate the failure
   - Fix the issues
   - Commit and push: `git add -A && git commit -m "fix: Address CI failures" && git push`
   - Re-check CI until it passes
4. Report final CI status

### Step 9: Check for Pending Migrations

If migration files were detected in Step 2:

```markdown
## Database Migration Required

This PR includes database schema changes:

| File | Description |
|------|-------------|
| `backend/migrations/NNNNNN_*.up.sql` | [Migration name] |

**Before testing this feature locally, run `/migrate` to apply the schema changes.**
```

### Step 10: Report Completion and STOP

**IMPORTANT: DO NOT MERGE. Wait for user approval.**

Report to the user:
- PR review completed successfully
- Number of review cycles used (X of 3)
- Any issues found and fixed
- Final CI status (pass/fail)
- Whether the PR is ready for merge
- **If migrations exist**: Remind to run `/migrate` before testing

End with this exact format:

```markdown
---

## PR Ready for Review

**Status:** [READY FOR MERGE / NEEDS ATTENTION]
**Review Cycles:** X/3
**CI:** [PASSED / FAILED]

**Awaiting your approval to merge.**

---

**PR:** https://github.com/notkevinvu/TaskFlow/pull/<NUMBER>
```

**STOP HERE. Do not merge unless the user explicitly requests it.**

---

## Notes

- This workflow uses 3 focused Sonnet agents for thorough code review
- Issues are scored to filter false positives (80+ threshold)
- Maximum 3 review->fix cycles to prevent infinite loops
- CI is verified after all review cycles complete
- **Workflow stops before merge** - user must explicitly approve
